# 知识库系统功能设计文档

## 功能需求分析

### 1. 知识的批量上传下载更新 ✅ 部分实现

**当前状态：**
- ✅ 已实现单文件上传（支持分片上传、秒传）
- ✅ 已实现批量下载接口（后端）
- ❌ 前端批量上传界面未完善
- ❌ 批量更新功能未实现

**设计方案：**

#### 1.1 批量上传
- **前端实现：**
  - 在知识库页面添加"批量上传"按钮
  - 支持拖拽多个文件或选择多个文件
  - 显示上传进度（每个文件的进度）
  - 支持暂停/继续/取消单个文件
  - 批量填写分类、摘要、关键词（应用到所有文件）

- **后端实现：**
  - 复用现有的分片上传接口
  - 支持并发上传多个文件
  - 返回批量上传结果（成功/失败列表）

#### 1.2 批量下载
- **前端实现：**
  - 在知识库列表添加复选框
  - 支持全选/反选
  - "批量下载"按钮，将选中的知识打包下载
  - 下载进度显示

- **后端实现：**
  - 已实现 `/file/batch/download` 接口
  - 需要实现打包为ZIP文件功能
  - 支持大文件打包（流式处理）

#### 1.3 批量更新
- **前端实现：**
  - 选中多个知识条目
  - "批量更新"按钮，弹出更新对话框
  - 支持批量修改：分类、状态、关键词等
  - 批量提交审核

- **后端实现：**
  - 新增 `/knowledge/batch/update` 接口
  - 支持事务处理，确保一致性

---

### 2. 热点知识统计(点击率,收藏率等) ✅ 已实现

**当前状态：**
- ✅ 已实现统计分析页面
- ✅ 已实现热点知识排行
- ✅ 已统计点击量、收藏量

**优化方案：**
- 添加更多统计维度：
  - 点击率 = 点击量 / 总用户数
  - 收藏率 = 收藏量 / 点击量
  - 平均停留时间
  - 最近7天/30天趋势图
- 添加图表展示（折线图、柱状图）
- 支持按时间范围筛选

---

### 3. 知识在线浏览(包含excel, word, pdf,视频等) ⚠️ 部分实现

**当前状态：**
- ✅ 已实现文件预览接口
- ✅ PDF预览（使用iframe）
- ❌ Word/Excel预览未实现
- ❌ 视频播放未优化

**设计方案：**

#### 3.1 PDF预览
- ✅ 已实现，使用iframe直接预览

#### 3.2 Word预览
- **方案1：** 使用 `mammoth.js` 将Word转换为HTML
- **方案2：** 使用 `docx-preview` 库
- **方案3：** 后端转换Word为PDF，然后预览PDF

#### 3.3 Excel预览
- **方案1：** 使用 `xlsx` 库解析Excel，前端渲染表格
- **方案2：** 使用 `luckysheet` 在线表格编辑器
- **方案3：** 后端转换为HTML表格

#### 3.4 视频播放
- 使用HTML5 `<video>` 标签
- 支持多种视频格式（MP4、WebM等）
- 添加播放控制（播放/暂停、进度条、音量等）
- 支持全屏播放

#### 3.5 图片预览
- 使用 `el-image-viewer` 组件
- 支持放大、缩小、旋转
- 支持图片列表切换

**实现优先级：**
1. 视频播放优化（高优先级）
2. Excel预览（中优先级）
3. Word预览（中优先级）

---

### 4. 关键字搜索(包含文本正文) ✅ 已实现

**当前状态：**
- ✅ 已实现全文搜索
- ✅ 已实现拼音、首字母搜索
- ✅ 已实现文件名搜索
- ✅ 已实现搜索高亮

**优化方案：**
- 添加搜索历史记录
- 添加热门搜索词
- 优化搜索算法（相关性排序）
- 添加高级搜索（多条件组合）

---

### 5. 完善规范的知识审批流程 ✅ 已实现

**当前状态：**
- ✅ 已实现审核流程（DRAFT -> PENDING -> APPROVED/REJECTED）
- ✅ 已实现审核页面
- ✅ 已实现审核意见填写

**优化方案：**
- 添加审核流程可视化（流程图）
- 支持多级审核（初审、复审）
- 添加审核时限提醒
- 支持审核委托
- 添加审核统计（审核通过率、平均审核时间等）

---

### 6. 针对知识点建立关联知识,知识评论区等 ❌ 未实现

**设计方案：**

#### 6.1 关联知识
- **数据库设计：**
  ```sql
  CREATE TABLE `knowledge_relation` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
    `knowledge_id` BIGINT NOT NULL COMMENT '知识ID',
    `related_knowledge_id` BIGINT NOT NULL COMMENT '关联知识ID',
    `relation_type` VARCHAR(50) COMMENT '关联类型：相关、引用、被引用、相似等',
    `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX `idx_knowledge_id` (`knowledge_id`),
    INDEX `idx_related_id` (`related_knowledge_id`)
  );
  ```

- **前端实现：**
  - 在知识详情页显示"关联知识"区域
  - 支持添加/删除关联知识
  - 显示关联类型标签
  - 支持点击跳转到关联知识

- **后端实现：**
  - 新增 `KnowledgeRelationService`
  - 接口：添加关联、删除关联、查询关联列表

#### 6.2 知识评论
- **数据库设计：**
  ```sql
  CREATE TABLE `knowledge_comment` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
    `knowledge_id` BIGINT NOT NULL COMMENT '知识ID',
    `user_id` BIGINT NOT NULL COMMENT '评论用户ID',
    `parent_id` BIGINT COMMENT '父评论ID（支持回复）',
    `content` TEXT NOT NULL COMMENT '评论内容',
    `status` VARCHAR(20) DEFAULT 'APPROVED' COMMENT '状态：APPROVED, PENDING, DELETED',
    `like_count` INT DEFAULT 0 COMMENT '点赞数',
    `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX `idx_knowledge_id` (`knowledge_id`),
    INDEX `idx_user_id` (`user_id`),
    INDEX `idx_parent_id` (`parent_id`)
  );
  
  CREATE TABLE `comment_like` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
    `comment_id` BIGINT NOT NULL,
    `user_id` BIGINT NOT NULL,
    `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
    UNIQUE KEY `uk_comment_user` (`comment_id`, `user_id`)
  );
  ```

- **前端实现：**
  - 在知识详情页添加"评论"标签页
  - 评论列表（支持嵌套回复）
  - 评论输入框（支持@用户）
  - 点赞功能
  - 评论排序（最新、最热）

- **后端实现：**
  - 新增 `CommentService`
  - 接口：发表评论、回复评论、删除评论、点赞评论、查询评论列表

**实现优先级：**
1. 关联知识（高优先级）
2. 知识评论（高优先级）

---

### 7. 知识结构变更支持拖拽等方式 ❌ 未实现

**设计方案：**

#### 7.1 知识树结构
- **数据库设计：**
  - 已有 `parent_id` 和 `sort_order` 字段
  - 需要添加 `level` 字段（层级深度）

- **前端实现：**
  - 使用 `vue-draggable` 或 `sortablejs` 实现拖拽
  - 树形结构展示（使用 `el-tree`）
  - 支持拖拽调整顺序和层级
  - 支持展开/折叠节点
  - 支持右键菜单（添加子节点、删除、移动等）

- **后端实现：**
  - 新增 `/knowledge/tree` 接口（获取知识树）
  - 新增 `/knowledge/move` 接口（移动知识节点）
  - 更新 `sort_order` 和 `parent_id`

#### 7.2 知识分类管理
- 支持分类的拖拽排序
- 支持分类的层级结构
- 支持分类的合并、拆分

**实现优先级：**
1. 知识树结构（中优先级）
2. 分类管理（低优先级）

---

## 实现优先级排序

### 高优先级（核心功能）
1. **关联知识和知识评论** - 增强知识互动性
2. **批量上传下载更新** - 提高工作效率
3. **在线浏览优化** - 提升用户体验

### 中优先级（重要功能）
4. **知识树结构拖拽** - 优化知识组织
5. **审批流程优化** - 完善管理流程

### 低优先级（优化功能）
6. **搜索功能优化** - 已有基础，继续优化
7. **统计功能增强** - 已有基础，添加更多维度

---

## 技术选型建议

### 前端
- **拖拽：** `sortablejs` 或 `vue-draggable`
- **树形组件：** Element Plus `el-tree`
- **图表：** `echarts` 或 `chart.js`
- **Word预览：** `docx-preview`
- **Excel预览：** `xlsx` + 自定义表格组件
- **视频播放：** HTML5 `<video>` 标签

### 后端
- **文件转换：** 
  - Word转PDF: `aspose-words` 或 `docx4j`
  - Excel转HTML: `poi` 或 `easyexcel`
- **ZIP打包：** `java.util.zip` 或 `zip4j`
- **并发处理：** `CompletableFuture` 或线程池

---

## 数据库变更

需要新增的表：
1. `knowledge_relation` - 知识关联表
2. `knowledge_comment` - 评论表
3. `comment_like` - 评论点赞表

需要修改的表：
1. `knowledge` - 添加 `level` 字段（可选）

