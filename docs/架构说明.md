# 系统架构说明

## 一、整体架构

### 1.1 技术栈
- **后端**: Spring Boot + Dubbo (微服务架构)
- **前端**: Vue 3 + Element Plus
- **数据库**: MySQL
- **服务注册中心**: Nacos

### 1.2 微服务模块
```
backend/
├── gateway-service/     # API网关服务（统一入口）
├── user-service/        # 用户服务（用户、部门管理）
├── knowledge-service/   # 知识服务（知识库管理）
├── file-service/        # 文件服务（文件上传下载）
├── audit-service/       # 审核服务（知识审核）
├── search-service/      # 搜索服务（ElasticSearch）
├── knowledge-api/       # API接口定义（DTO、Service接口）
└── knowledge-common/    # 公共模块（工具类、常量、实体基类）
```

## 二、用户与部门管理架构

### 2.1 核心概念

#### 角色定义
- **ADMIN（系统管理员）**: 
  - 没有部门归属（department_id = NULL）
  - 可以管理部门
  - 可以创建其他系统管理员
  - 拥有所有权限

- **EDITOR（知识管理员）**: 
  - 必须属于某个部门
  - 可以上传、编辑知识
  - 可以提交审核

- **USER（普通用户）**: 
  - 必须属于某个部门
  - 只能查看、搜索、下载知识

#### 部门管理
- 部门由系统管理员创建和管理
- 用户注册时从已有部门中选择
- 系统管理员注册时不需要选择部门

### 2.2 数据模型

#### 部门表（department）
```sql
CREATE TABLE `department` (
    `id` BIGINT PRIMARY KEY,
    `name` VARCHAR(100) UNIQUE NOT NULL,
    `description` VARCHAR(500),
    ...
)
```

#### 用户表（user）
```sql
CREATE TABLE `user` (
    `id` BIGINT PRIMARY KEY,
    `username` VARCHAR(50) UNIQUE NOT NULL,
    `password` VARCHAR(255) NOT NULL,
    `real_name` VARCHAR(50),
    `email` VARCHAR(100),
    `department_id` BIGINT NULL,  -- 系统管理员为NULL
    `role` VARCHAR(20) DEFAULT 'USER',
    ...
    FOREIGN KEY (`department_id`) REFERENCES `department`(`id`)
)
```

### 2.3 验证规则

#### 统一验证工具类：`UserValidationUtil`
- `isValidRole(role)`: 验证角色是否有效
- `isAdminRole(role)`: 判断是否为系统管理员
- `validateDepartment(role, departmentId)`: 验证部门
  - 系统管理员：departmentId可以为null
  - 其他角色：departmentId必须不为null
- `validateRegisterRole(role)`: 验证注册角色
  - 注册时不允许选择系统管理员（系统管理员只能由其他系统管理员创建）

#### 统一DTO转换工具类：`UserDTOUtil`
- `toDTO(user, departmentMapper)`: 将User转换为UserDTO，并填充部门名称
- `fillDepartmentName(userDTO, user, departmentMapper)`: 填充部门名称
  - 有部门ID：查询部门名称
  - 系统管理员：显示"系统"
- `setDepartmentId(user, role, departmentId)`: 设置部门ID
  - 系统管理员：设置为null
  - 其他角色：设置为指定值

### 2.4 服务层架构

#### UserService（用户服务）
- `getUserById(userId)`: 获取用户信息（自动填充部门名称）
- `getUserByUsername(username)`: 根据用户名获取用户（自动填充部门名称）
- `createUser(userDTO)`: 创建用户（系统管理员创建）
  - 验证角色和部门
  - 系统管理员不设置部门
- `register(username, password, realName, email, departmentId, role)`: 用户注册
  - 不允许注册系统管理员
  - 非系统管理员必须选择部门
- `updateUser(userDTO)`: 更新用户信息
  - 系统管理员不设置部门
  - 允许更新角色（仅系统管理员可以修改角色）
- `login(username, password)`: 用户登录（自动填充部门名称）

#### DepartmentService（部门服务）
- `createDepartment(departmentDTO)`: 创建部门
- `updateDepartment(departmentDTO)`: 更新部门
- `deleteDepartment(id)`: 删除部门
- `getDepartmentById(id)`: 获取部门信息
- `getAllDepartments()`: 获取所有部门列表

### 2.5 Controller层架构

#### AuthController（认证控制器）
- `POST /api/auth/login`: 用户登录
- `POST /api/auth/register`: 用户注册
  - 支持注册：USER、EDITOR
  - 系统管理员注册时departmentId为null

#### UserController（用户控制器）
- `GET /api/user/{id}`: 获取用户信息
- `POST /api/user`: 创建用户（系统管理员操作）
- `PUT /api/user/{id}`: 更新用户信息
- `PUT /api/user/{id}/password`: 修改密码
- `GET /api/user/departments`: 获取部门列表（已废弃，使用DepartmentController）

#### DepartmentController（部门控制器）
- `POST /api/department`: 创建部门
- `PUT /api/department/{id}`: 更新部门
- `DELETE /api/department/{id}`: 删除部门
- `GET /api/department/{id}`: 获取部门信息
- `GET /api/department`: 获取所有部门列表

## 三、前端架构

### 3.1 页面结构

#### 注册页面（Register.vue）
- 支持选择角色：USER、EDITOR、ADMIN
- 系统管理员注册时：
  - 部门字段隐藏
  - 显示提示："系统管理员无需选择部门"
- 其他角色注册时：
  - 部门字段必填
  - 从部门列表下拉选择

#### 用户管理页面（UserManagement.vue）
- 系统管理员显示部门为"系统"
- 添加/编辑用户时：
  - 系统管理员：不显示部门字段
  - 其他角色：部门字段必填

#### 部门管理页面（DepartmentManagement.vue）
- 部门列表展示
- 创建、编辑、删除部门
- 仅系统管理员可见

### 3.2 路由与权限

#### 路由配置
- `/register`: 注册页面（公开）
- `/login`: 登录页面（公开）
- `/department-management`: 部门管理（需要MANAGE_USER权限）
- `/user-management`: 用户管理（需要MANAGE_USER权限）

#### 权限控制
- 使用`hasPermission(userInfo, permission)`检查权限
- 系统管理员拥有`MANAGE_USER`权限，可以访问：
  - 部门管理
  - 用户管理

## 四、代码组织原则

### 4.1 分层架构
1. **Controller层**: 处理HTTP请求，参数验证，调用Service
2. **Service层**: 业务逻辑处理，调用Mapper
3. **Mapper层**: 数据库操作（MyBatis Plus）
4. **Entity层**: 数据库实体
5. **DTO层**: 数据传输对象（API接口定义）

### 4.2 工具类组织
- **UserValidationUtil**: 用户验证逻辑（角色、部门验证）
- **UserDTOUtil**: 用户DTO转换（统一处理部门信息填充）
- **PasswordUtil**: 密码加密工具

### 4.3 代码复用原则
- 部门验证逻辑统一在`UserValidationUtil`中
- 部门名称填充统一在`UserDTOUtil`中
- 避免在多个方法中重复相同的验证和转换逻辑

## 五、关键业务规则

### 5.1 用户注册规则
1. 不允许注册系统管理员（系统管理员只能由其他系统管理员创建）
2. 系统管理员注册时不需要选择部门（departmentId为null）
3. 其他角色注册时必须选择部门

### 5.2 用户创建规则（系统管理员操作）
1. 可以创建任何角色的用户
2. 系统管理员用户不设置部门
3. 其他角色用户必须设置部门

### 5.3 用户更新规则
1. 系统管理员可以修改任何用户的角色
2. 系统管理员用户不设置部门
3. 其他角色用户必须设置部门

### 5.4 部门管理规则
1. 只有系统管理员可以创建、编辑、删除部门
2. 删除部门前需要检查是否有用户使用该部门（建议在Controller层检查）

## 六、注意事项

1. **数据一致性**: 
   - 系统管理员的department_id必须为NULL
   - 非系统管理员的department_id必须不为NULL

2. **权限控制**: 
   - 系统管理员拥有所有权限
   - 部门管理功能仅系统管理员可见

3. **前端验证**: 
   - 前端验证只是用户体验优化
   - 后端必须进行完整的验证

4. **向后兼容**: 
   - `UserService.getAllDepartments()`已废弃
   - 应使用`DepartmentService.getAllDepartments()`

