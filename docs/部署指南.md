# 部署指南

## 环境准备

### 方式一：使用Docker（推荐）

使用Docker Compose一键启动所有基础服务，无需手动安装配置。

#### 1. 安装Docker和Docker Compose

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install docker.io docker-compose

# 启动Docker服务
sudo systemctl start docker
sudo systemctl enable docker

# 将当前用户添加到docker组（避免每次使用sudo）
sudo usermod -aG docker $USER
# 重新登录使配置生效
```

#### 2. 启动基础服务

```bash
# 在项目根目录执行
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

#### 3. 访问服务

- **Nacos控制台**: http://localhost:8848/nacos
  - 用户名: nacos
  - 密码: nacos
- **Kibana**: http://localhost:5601
- **ElasticSearch**: http://localhost:9200

#### 4. 初始化数据库

**自动初始化：**

数据库会在MySQL容器首次启动时自动初始化。`docker-compose.yml`已经配置了自动执行：
- `sql/init.sql` - 初始化knowledge_db数据库（表结构）
- `sql/mysql-schema.sql` - 初始化nacos_config数据库

**导入测试数据（可选）：**

如果需要测试数据（测试账号、测试知识等），执行：

```bash
# 导入测试数据
sudo docker exec -i knowledge-mysql mysql -uroot -proot knowledge_db < sql/test_data.sql
```

**注意：** 
- MySQL容器的`/docker-entrypoint-initdb.d/`目录只在首次初始化时执行SQL文件
- 如果数据库已存在，不会再次执行初始化脚本
- 如果需要重新初始化，需要删除数据卷：`docker-compose down -v`

### 方式二：手动安装（不推荐）

如果需要手动安装，请参考以下步骤：

#### 1. 基础环境

- **JDK 1.8+**: 安装并配置JAVA_HOME
- **Maven 3.6+**: 配置M2_HOME
- **MySQL 8.0+**: 创建数据库
- **Redis**: 用于缓存和会话管理
- **ElasticSearch 7.x**: 用于全文搜索
- **Nacos 2.x**: 服务注册与发现
- **Node.js 16+**: 前端开发环境

#### 2. 安装Nacos

```bash
# 下载Nacos
wget https://github.com/alibaba/nacos/releases/download/2.2.3/nacos-server-2.2.3.tar.gz
tar -xzf nacos-server-2.2.3.tar.gz
cd nacos/bin

# 启动Nacos（单机模式）
sh startup.sh -m standalone
```

访问 http://localhost:8848/nacos，默认用户名/密码：nacos/nacos

#### 3. 安装ElasticSearch

```bash
# 下载ElasticSearch 7.17.9
wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.17.9-linux-x86_64.tar.gz
tar -xzf elasticsearch-7.17.9-linux-x86_64.tar.gz
cd elasticsearch-7.17.9

# 启动ElasticSearch
./bin/elasticsearch
```

#### 4. 初始化数据库

```bash
# 在项目根目录执行
mysql -u root -p < sql/init.sql

# 或手动执行
mysql -u root -p
CREATE DATABASE knowledge_db;
USE knowledge_db;
SOURCE sql/init.sql;
```

### 配置文件修改

#### Docker环境

如果使用Docker，各服务会自动使用Docker网络中的服务名（mysql、redis、elasticsearch、nacos）。

启动应用服务时使用docker profile：
```bash
cd backend
export SPRING_PROFILES_ACTIVE=docker
mvn spring-boot:run
```

#### 本地环境

修改各服务的 `backend/*/src/main/resources/application.yml` 中的配置：

- **数据库连接**: 根据实际情况修改MySQL连接信息（默认：`localhost:3306`）
- **Redis连接**: 修改Redis主机和端口（默认：`localhost:6379`）
- **ElasticSearch**: 修改ES连接信息（默认：`localhost:9200`）
- **Nacos注册中心**: 确保Nacos地址正确（默认：`localhost:8848`）
- **文件存储路径**: 修改文件上传和分片存储路径（默认：`/data/files` 和 `/data/chunks`）

## 启动步骤

### 1. 启动基础服务（Docker）

```bash
# 在项目根目录执行
docker-compose up -d

# 或使用脚本
chmod +x docker/start-docker.sh
./docker/start-docker.sh
```

等待服务启动完成（约30-60秒），可以通过以下命令检查：

```bash
# 检查MySQL
docker-compose exec mysql mysqladmin ping -h localhost -uroot -proot

# 检查Redis
docker-compose exec redis redis-cli ping

# 检查ElasticSearch
curl http://localhost:9200

# 检查Nacos
curl http://localhost:8848/nacos/
```

### 2. 启动应用服务

#### 方式一：使用启动脚本（推荐）

```bash
# 进入WSL环境
wsl

# 进入项目根目录
cd /mnt/c/Users/ZeroHzzzz/Desktop/java

# 进入后端目录
cd backend

# 设置Docker环境变量（如果使用Docker）
export SPRING_PROFILES_ACTIVE=docker

# 启动所有服务
./start.sh
```

#### 方式二：手动启动

```bash
# 进入后端目录
cd backend

# 1. 编译项目
mvn clean install -DskipTests

# 2. 设置环境变量（Docker环境）
export SPRING_PROFILES_ACTIVE=docker

# 3. 启动各个服务（按顺序）
cd file-service && mvn spring-boot:run &
cd ../knowledge-service && mvn spring-boot:run &
cd ../search-service && mvn spring-boot:run &
cd ../audit-service && mvn spring-boot:run &
cd ../user-service && mvn spring-boot:run &
cd ../gateway-service && mvn spring-boot:run &
```

### 3. 启动前端

```bash
# 在项目根目录执行
cd frontend

# 安装依赖（首次运行）
npm install

# 启动开发服务器
npm run dev
```

访问 http://localhost:3000

## 验证服务

### 检查服务注册

访问 Nacos 控制台：http://localhost:8848/nacos

在"服务管理" -> "服务列表"中应该能看到所有注册的服务：
- file-service
- knowledge-service
- search-service
- audit-service
- user-service
- gateway-service

### 测试API

```bash
# 测试网关服务
curl http://localhost:8080/api/knowledge/list

# 测试文件服务
curl http://localhost:8081/api/file/init
```

## 常见问题

### 1. 服务启动失败

- 检查端口是否被占用
- 检查数据库连接是否正常
- 检查Nacos是否启动
- 查看日志文件：`backend/logs/*.log`

### 2. 服务未注册到Nacos

- 检查Nacos是否正常运行
- 检查`backend/*/src/main/resources/application.yml`中的Nacos地址配置
- 检查网络连接
- 确认使用了正确的profile（Docker环境使用`application-docker.yml`）

### 3. ElasticSearch连接失败

- 检查ElasticSearch是否启动
- 检查端口9200是否可访问
- 检查防火墙设置

### 4. 文件上传失败

- 检查文件存储路径是否存在且有写权限
- 检查磁盘空间是否充足
- 查看file-service日志

### 5. Nacos启动失败（No DataSource set 或表不存在）

如果Nacos启动时出现数据库相关错误：

**方式一：使用修复脚本（推荐）**
```bash
cd /mnt/c/Users/ZeroHzzzz/Desktop/java
bash docker/fix-nacos-database.sh
```

**方式二：手动修复**
```bash
# 停止容器
sudo docker compose down

# 重新初始化数据库
sudo docker compose exec -T mysql mysql -uroot -proot -e "DROP DATABASE IF EXISTS nacos_config;"
sudo docker compose exec -T mysql mysql -uroot -proot -e "CREATE DATABASE nacos_config CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
sudo docker compose exec -T mysql mysql -uroot -proot nacos_config < sql/mysql-schema.sql

# 重启服务
sudo docker compose up -d
```

### 6. WSL环境下无法访问Docker服务

在WSL环境中，容器显示的IP（如`172.18.0.6`）是内部地址，无法从Windows直接访问。

**解决方案**：
- 使用 `localhost` 访问：http://localhost:8848/nacos
- 检查端口映射：确保 `docker-compose.yml` 中端口映射正确
- 检查Windows防火墙：确保端口未被阻止

### 7. 手动启动服务（不使用脚本）

如果需要手动启动各个服务：

```bash
# 1. 编译项目
cd backend
mvn clean install -DskipTests

# 2. 设置环境变量
export SPRING_PROFILES_ACTIVE=docker

# 3. 按顺序启动（每个服务需要独立终端）
cd user-service && mvn spring-boot:run
cd file-service && mvn spring-boot:run
cd knowledge-service && mvn spring-boot:run
cd search-service && mvn spring-boot:run
cd audit-service && mvn spring-boot:run
cd gateway-service && mvn spring-boot:run  # 最后启动
```

**注意**：必须按顺序启动，gateway-service 必须最后启动。

## 生产环境部署

### 1. 使用Docker（推荐）

创建 `docker-compose.yml` 文件，包含所有服务的容器配置。

### 2. 使用JAR包部署

```bash
# 进入后端目录
cd backend

# 打包
mvn clean package -DskipTests

# 运行（设置Docker环境变量）
export SPRING_PROFILES_ACTIVE=docker

# 运行各个服务
java -jar file-service/target/file-service-1.0.0.jar
java -jar knowledge-service/target/knowledge-service-1.0.0.jar
java -jar search-service/target/search-service-1.0.0.jar
java -jar audit-service/target/audit-service-1.0.0.jar
java -jar user-service/target/user-service-1.0.0.jar
java -jar gateway-service/target/gateway-service-1.0.0.jar
```

### 3. 使用Nginx反向代理

配置Nginx将请求转发到gateway-service。

## 监控和日志

- 日志文件位置：`backend/logs/` 目录
- 应用监控：集成Spring Boot Actuator
- 服务监控：使用Nacos监控功能

## 项目目录说明

```
java/
├── backend/              # 后端代码目录
│   ├── pom.xml          # Maven父POM
│   ├── start.sh         # 启动脚本
│   ├── stop.sh          # 停止脚本
│   └── logs/            # 日志目录（运行时创建）
│
├── frontend/            # 前端代码目录
│   ├── src/            # 源代码
│   └── package.json    # 依赖配置
│
├── docker/              # Docker脚本
├── sql/                 # 数据库脚本
├── docs/                # 项目文档
└── docker-compose.yml   # Docker Compose配置
```

**重要提示：**
- 后端编译和启动必须在 `backend/` 目录下执行
- 前端开发必须在 `frontend/` 目录下执行
- Docker操作在项目根目录执行

