# 监控系统说明文档 - Prometheus + Grafana + Loki (PLG Stack)

## 一、整体架构

本项目采用 **PLG Stack**（Prometheus + Loki + Grafana）作为监控和日志解决方案：

```
┌─────────────────────────────────────────────────────────────┐
│                     应用服务层                                │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │gateway   │  │knowledge │  │file      │  │search    │   │
│  │:8080     │  │:8082     │  │:8081     │  │:8083     │   │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘   │
│       │             │              │              │         │
│       └─────────────┴──────────────┴──────────────┘         │
│                    │                                          │
│            Spring Boot Actuator                               │
│            /actuator/prometheus                               │
└────────────────────┼─────────────────────────────────────────┘
                     │
        ┌────────────┴────────────┐
        │                         │
        ▼                         ▼
┌───────────────┐        ┌───────────────┐
│  Prometheus   │        │   Promtail    │
│  (指标采集)    │        │  (日志收集)    │
│  :9090        │        │  :9080        │
└───────┬───────┘        └───────┬───────┘
        │                        │
        │                        ▼
        │                ┌───────────────┐
        │                │     Loki      │
        │                │  (日志聚合)    │
        │                │    :3100      │
        │                └───────┬───────┘
        │                        │
        └────────────┬───────────┘
                     │
                     ▼
            ┌─────────────────┐
            │    Grafana      │
            │  (可视化大盘)    │
            │     :3001       │
            └─────────────────┘
```

## 二、Prometheus - 指标采集

### 2.1 工作原理

**Prometheus** 是一个开源的监控和告警系统，采用 **Pull 模式**（拉取模式）采集指标。

#### 2.1.1 指标暴露（应用端）

**Spring Boot Actuator + Micrometer** 负责暴露指标：

1. **依赖配置**：
   ```xml
   <!-- backend/pom.xml -->
   <dependency>
       <groupId>org.springframework.boot</groupId>
       <artifactId>spring-boot-starter-actuator</artifactId>
   </dependency>
   <dependency>
       <groupId>io.micrometer</groupId>
       <artifactId>micrometer-registry-prometheus</artifactId>
   </dependency>
   ```

2. **应用配置**（`application.yml`）：
   ```yaml
   management:
     endpoints:
       web:
         exposure:
           include: "*"  # 暴露所有端点
     endpoint:
       health:
         show-details: always
     metrics:
       tags:
         application: ${spring.application.name}  # 添加应用标签
   ```

3. **指标端点**：
   - 每个微服务启动后，自动暴露 `/actuator/prometheus` 端点
   - 该端点返回 **Prometheus 格式**的指标数据（文本格式）
   - 示例：`http://localhost:8080/actuator/prometheus`

4. **自动采集的指标**：
   - **JVM 指标**：堆内存、非堆内存、GC 次数、GC 耗时
   - **HTTP 指标**：请求总数、请求耗时、错误率
   - **数据库连接池指标**：HikariCP 连接数、活跃连接、等待连接
   - **自定义指标**：业务指标（如知识数量、文件上传数等）

#### 2.1.2 指标抓取（Prometheus 端）

**Prometheus** 定期从应用端点拉取指标：

1. **配置文件**（`docker/prometheus/prometheus.yml`）：
   ```yaml
   global:
     scrape_interval: 15s  # 每15秒抓取一次

   scrape_configs:
     - job_name: 'backend-services'
       metrics_path: '/actuator/prometheus'
       static_configs:
         - targets:
           - 'host.docker.internal:8080'  # gateway-service
           - 'host.docker.internal:8081'  # file-service
           - 'host.docker.internal:8082'  # knowledge-service
           - 'host.docker.internal:8083'  # search-service
           - 'host.docker.internal:8084'  # audit-service
           - 'host.docker.internal:8085'  # user-service
   ```

2. **抓取流程**：
   - Prometheus 每 15 秒向每个服务的 `/actuator/prometheus` 端点发送 HTTP GET 请求
   - 获取指标数据后，存储到本地时序数据库（TSDB）
   - 指标数据以时间序列（Time Series）形式存储：`metric_name{label1="value1", label2="value2"} value timestamp`

3. **指标示例**：
   ```
   # JVM 堆内存使用量
   jvm_memory_used_bytes{application="knowledge-service", area="heap", id="PS Survivor Space"} 1234567

   # HTTP 请求总数
   http_server_requests_seconds_count{application="gateway-service", method="GET", status="200", uri="/api/knowledge/list"} 1500

   # 数据库连接池活跃连接数
   hikaricp_connections_active{application="knowledge-service", pool="HikariPool-1"} 5
   ```

### 2.2 访问方式

- **Prometheus UI**: http://localhost:9090
- **查看 Targets**: http://localhost:9090/targets （查看抓取目标状态）
- **查询指标**: http://localhost:9090/graph （使用 PromQL 查询）

### 2.3 常用 PromQL 查询示例

```promql
# 查询所有服务的 HTTP 请求总数
sum(http_server_requests_seconds_count) by (application)

# 查询 JVM 堆内存使用率
jvm_memory_used_bytes{area="heap"} / jvm_memory_max_bytes{area="heap"} * 100

# 查询平均响应时间（最近5分钟）
rate(http_server_requests_seconds_sum[5m]) / rate(http_server_requests_seconds_count[5m])

# 查询错误率（状态码 >= 500）
sum(rate(http_server_requests_seconds_count{status=~"5.."}[5m])) / sum(rate(http_server_requests_seconds_count[5m])) * 100
```

## 三、Loki - 日志聚合

### 3.1 工作原理

**Loki** 是一个水平可扩展、高可用的日志聚合系统，设计理念是**只索引元数据，不索引日志内容**，因此非常轻量级。

#### 3.1.1 日志收集（Promtail）

**Promtail** 是日志收集代理，负责从多个来源收集日志并推送到 Loki：

1. **配置文件**（`docker/promtail/promtail-config.yml`）：
   ```yaml
   clients:
     - url: http://loki:3100/loki/api/v1/push  # Loki 推送地址

   scrape_configs:
     # 收集 Docker 容器日志
     - job_name: docker
       docker_sd_configs:
         - host: unix:///var/run/docker.sock
           refresh_interval: 5s
       relabel_configs:
         - source_labels: ['__meta_docker_container_name']
           regex: '/(.*)'
           target_label: 'container'

     # 收集应用日志文件
     - job_name: backend-logs
       static_configs:
         - targets:
             - localhost
           labels:
             job: backend
             __path__: /var/log/backend-logs/*.log  # 应用日志路径
   ```

2. **日志来源**：
   - **Docker 容器日志**：通过 Docker Socket 自动发现容器，收集 `stdout` 和 `stderr` 输出
   - **应用日志文件**：从 `backend/logs/` 目录收集日志文件（如 `gateway-service.log`）

3. **日志标签（Labels）**：
   - Promtail 为每条日志添加标签，用于查询和过滤
   - 标签示例：`{container="knowledge-gateway", job="docker"}` 或 `{job="backend", filename="gateway-service.log"}`

#### 3.1.2 日志存储（Loki）

**Loki** 接收 Promtail 推送的日志：

1. **配置文件**（`docker/loki/loki-config.yml`）：
   ```yaml
   server:
     http_listen_port: 3100

   common:
     path_prefix: /loki
     storage:
       filesystem:
         chunks_directory: /loki/chunks  # 日志块存储目录
         rules_directory: /loki/rules
     replication_factor: 1

   schema_config:
     configs:
       - from: 2020-10-24
         store: boltdb-shipper
         object_store: filesystem
         schema: v11
         index:
           prefix: index_
           period: 24h
   ```

2. **存储机制**：
   - **只索引元数据**：Loki 只索引日志的标签（Labels），不索引日志内容
   - **日志内容存储**：日志内容以块（Chunk）形式存储在文件系统中
   - **查询方式**：通过标签快速定位日志，然后读取对应的日志块

3. **优势**：
   - **轻量级**：相比 ELK Stack，Loki 资源占用更少
   - **快速查询**：通过标签查询，速度更快
   - **成本低**：不需要为日志内容建立索引

### 3.2 访问方式

- **Loki API**: http://localhost:3100
- **查询日志**: 通过 Grafana 的 Logs 面板查询（见下文）

### 3.3 日志查询语法（LogQL）

```logql
# 查询特定容器的日志
{container="knowledge-gateway"}

# 查询包含 "ERROR" 的日志
{job="backend"} |= "ERROR"

# 查询特定时间范围的日志
{container="knowledge-gateway"} [5m]

# 统计错误日志数量
sum(count_over_time({job="backend"} |= "ERROR" [1m]))
```

## 四、Grafana - 可视化大盘

### 4.1 工作原理

**Grafana** 是一个开源的可视化平台，连接 Prometheus 和 Loki 作为数据源，提供统一的监控大盘。

#### 4.1.1 数据源配置

**自动配置**（`docker/grafana/datasources.yml`）：
```yaml
apiVersion: 1

datasources:
  - name: Prometheus
    type: prometheus
    url: http://prometheus:9090
    isDefault: true
    access: proxy

  - name: Loki
    type: loki
    url: http://loki:3100
    access: proxy
```

#### 4.1.2 监控大盘

**Spring Boot 监控大盘**（`docker/grafana/springboot-dashboard.json`）：
- 预配置的 Spring Boot 应用监控大盘
- 包含以下面板：
  - **JVM 指标**：堆内存、非堆内存、GC 统计
  - **HTTP 指标**：请求总数、响应时间、错误率
  - **数据库连接池**：连接数、活跃连接、等待连接
  - **系统指标**：CPU、内存、磁盘、网络

#### 4.1.3 日志查询面板

- **Logs 面板**：查询和展示 Loki 中的日志
- **支持功能**：
  - 按标签过滤日志
  - 搜索日志内容
  - 时间范围选择
  - 日志高亮显示

### 4.2 访问方式

- **Grafana UI**: http://localhost:3001
- **默认账号**: `admin` / `Zhz050108`（可在 `docker-compose.yml` 中配置）
- **Spring Boot 大盘**: http://localhost:3001/d/28e3358f-3fac-4321-804f-420e116de8a1/spring-boot-statistics

## 五、数据流转流程

### 5.1 指标采集流程

```
1. 应用启动
   ↓
2. Spring Boot Actuator 自动采集 JVM、HTTP 等指标
   ↓
3. Micrometer 将指标转换为 Prometheus 格式
   ↓
4. 暴露 /actuator/prometheus 端点
   ↓
5. Prometheus 每 15 秒抓取一次指标
   ↓
6. 存储到 Prometheus TSDB
   ↓
7. Grafana 从 Prometheus 查询指标并可视化
```

### 5.2 日志采集流程

```
1. 应用输出日志
   ├─→ stdout/stderr (Docker 容器日志)
   └─→ 日志文件 (backend/logs/*.log)
        ↓
2. Promtail 发现并收集日志
   ├─→ 通过 Docker Socket 收集容器日志
   └─→ 从文件系统读取日志文件
        ↓
3. Promtail 添加标签（container、job、filename 等）
        ↓
4. Promtail 推送到 Loki
        ↓
5. Loki 存储日志（只索引标签，不索引内容）
        ↓
6. Grafana 从 Loki 查询日志并展示
```

## 六、实际使用示例

### 6.1 查看服务健康状态

1. 访问 Grafana: http://localhost:3001
2. 进入 Spring Boot 监控大盘
3. 选择应用（如 `gateway-service`）
4. 查看 **Health** 面板，查看服务健康状态

### 6.2 查看 JVM 内存使用

1. 在 Grafana 大盘中选择 **JVM Memory** 面板
2. 查看堆内存、非堆内存使用情况
3. 可以设置告警阈值（如堆内存使用率 > 80%）

### 6.3 查看 HTTP 请求统计

1. 在 Grafana 大盘中选择 **HTTP Request** 面板
2. 查看请求总数、平均响应时间、错误率
3. 可以按 URI、方法、状态码等维度分析

### 6.4 查询应用日志

1. 在 Grafana 中创建 **Logs** 面板
2. 选择数据源：Loki
3. 输入查询：`{container="knowledge-gateway"} |= "ERROR"`
4. 查看错误日志

### 6.5 设置告警规则

1. 在 Grafana 中创建 **Alert** 规则
2. 设置条件：如 `jvm_memory_used_bytes / jvm_memory_max_bytes > 0.8`
3. 配置通知渠道（邮件、钉钉、企业微信等）
4. 当条件满足时自动发送告警

## 七、优势总结

### 7.1 Prometheus 优势

- **Pull 模式**：主动拉取，不依赖应用推送
- **多维数据模型**：通过标签灵活查询
- **强大的查询语言**：PromQL 支持复杂查询
- **轻量级**：资源占用少，易于部署

### 7.2 Loki 优势

- **轻量级**：只索引元数据，不索引内容
- **成本低**：存储和查询成本远低于 ELK
- **与 Prometheus 集成**：使用相同的标签系统
- **快速查询**：通过标签快速定位日志

### 7.3 Grafana 优势

- **统一平台**：指标和日志在一个平台查看
- **丰富的可视化**：支持多种图表类型
- **灵活的告警**：支持多种告警规则和通知渠道
- **易于扩展**：支持插件和自定义面板

## 八、配置说明

### 8.1 修改抓取间隔

编辑 `docker/prometheus/prometheus.yml`：
```yaml
global:
  scrape_interval: 30s  # 改为30秒
```

### 8.2 添加新的监控目标

编辑 `docker/prometheus/prometheus.yml`：
```yaml
scrape_configs:
  - job_name: 'backend-services'
    static_configs:
      - targets:
        - 'host.docker.internal:8080'
        - 'host.docker.internal:8086'  # 添加新服务
```

### 8.3 修改日志收集路径

编辑 `docker/promtail/promtail-config.yml`：
```yaml
scrape_configs:
  - job_name: backend-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: backend
          __path__: /var/log/backend-logs/*.log  # 修改路径
```

## 九、常见问题

### Q1: Prometheus 无法抓取指标？

**检查**：
1. 应用是否正常启动
2. `/actuator/prometheus` 端点是否可访问
3. Prometheus 配置中的 targets 地址是否正确
4. 网络是否连通（Docker 网络配置）

### Q2: Loki 中看不到日志？

**检查**：
1. Promtail 是否正常运行
2. 日志文件路径是否正确
3. Promtail 是否有读取权限
4. Loki 是否正常运行

### Q3: Grafana 无法连接数据源？

**检查**：
1. Prometheus 和 Loki 是否正常运行
2. Grafana 数据源配置中的 URL 是否正确
3. Docker 网络是否配置正确

## 十、总结

本项目采用 **PLG Stack** 实现了完整的监控和日志解决方案：

- **Prometheus**：采集和存储应用指标（JVM、HTTP、数据库等）
- **Loki**：聚合和存储应用日志（容器日志、文件日志）
- **Grafana**：统一的可视化平台，展示指标和日志

该方案具有**轻量级、易部署、成本低**的特点，非常适合中小型项目的监控需求。

